## РПЗ по предмету "Проектирование высоконагруженных систем". Технопарк, весна 2022
Airbnb - Онлайн-площадка для размещения и поиска краткосрочной аренды частного жилья по всему миру.

### 1. Тема и целевая аудитория
#### MVP
Основной функционал сервиса:
* Регистрация и авторизация
* Поиск объявлений
* Размещение объявлений
* Бронирование жилья

#### Целевая аудитория
На 2018 года общая аудитория сервиса составляет ***150*** млн. чел. [[1]](#source-1).
На 2022 год общая аудитория оценивается менее ***200*** млн. чел. [[1]](#source-1).

За 2021 год число объявлений составляет ***6*** млн. [[1]](#source-1).
За 2021 год число заказов составляет ***300*** млн. [[1]](#source-1).

Ежемесячная аудитория на март 2022 года представлена в таблице [[2]](#source-2):

|      Страны      |  Ежемесячная аудитория, млн. чел.  | Доля от общего числа пользователь |
|:----------------:|:----------------------------------:|:---------------------------------:|
|       США        |                 91                 |               52,6%               |
|  Великобритания  |                15,9                |               9,2%                |
|     Франция      |                15,6                |               9,1%                |
|     Германия     |                8,9                 |               5,1%                |
|        РФ        |                 2                  |               1,2%                |
|    Австралия     |                 7                  |               4,0%                |
|      Канада      |                 9                  |               5,2%                |
|     Бразилия     |                9,7                 |               5,6%                |
|      Италия      |                6,9                 |               3,9%                |
|     Мексика      |                5,5                 |               3,1%                |


Среднее количество страниц за посещение сервиса составляет ***20,48*** страниц [[2]](#source-2).


#### 2. Расчет нагрузки

##### Продуктовые метрики

* **Месячная аудитория** - ***171,5*** млн. чел.
* **Дневная аудитория** - ***13,71*** млн. чел.
* **Средний размер хранилища пользователя**
  Существуют следующие типы хранимой информации:
1. **Личный профиль**, содержащий аватар а также данные - уникальный идентификатор, адрес электронной почты, имя, город, номер телефона, пароль.

| Аватар |   Личные данные    | Всего данных |
|:------:|:------------------:|:------------:|
| 250 Кб |       500 б        |   0.245 Мб   |

2. **Объявление**. Среднее описание места составляет ~500 символов -> 500 байт + ~20 байт на дополнительную информацию (категория, состояние, арендодатель и проч.)  -> 620 байт. Также в каждом объявлении может содержаться в среднем 9 изображений. Если взять средний размер за 300 Кб, то еще 2 764 000 байт. Итого 2 765 420 байт.

| Описание | Дополнительная информация | Изображение | Количество изображений | Всего данных |
|:--------:|:-------------------------:|:-----------:|:----------------------:|:------------:|
|  600 б   |           20 б            |   300 Кб    |           9            |   2.64 Мб    |

  Итого получается среднее хранилище пользователя ***2,885*** Мб

* **Среднее количество действий пользователя по типам в день**

Всего в месяц на авито на момент августа 2021 года приходится 171,5 млн. посещений и 13,71 млн. посещений в день. Среднее время сессии составляет 8 минут 35 секунд, за это время посещаются 20.48 страниц [[2]](#source-1).

1. **Авторизация или Регистрация**
В среднем можно предположить, что в день человек выполнить ***один*** запрос на вход или регистрацию.

2. **Поиск**
В среднем, человек обычно ищет какую-то определенную вещь, также возможно, его не устраивает результат запроса и он отправляет уточненный запрос, то есть осуществляет ***2*** запроса по поиску.

3. **Просмотр объявления**
Исходя из данных выше, пользователь просматривает ***~18*** объявлений.

4. **Создание объявления**
За год открывается около 6 млн. объявлений [[1]](#source-1), следовательно в день их число может состовлять 6 000 000 / 365 = 16 438.
Следовательно при 13,71 млн. посещений в день, на одного пользователя получается 16 438 / 13 710 000 = ***0,001*** запроса в день.

5. **Бронирование объявления**
За год происходит около 300 млн. бронирований [[1]](#source-1), следовательно в день их число может состовлять 300 000 000 / 365 = 821 917.
Следовательно при 13,71 млн. посещений в день, на одного пользователя получается 821 917 / 13 710 000 = ***0,059*** запроса в день.

**Итого**

| Авторизация или Регистрация | Поиск | Просмотр объявления | Создание объявления | Бронирование объявления | 
|:---------------------------:|:-----:|:-------------------:|:-------------------:|:-----------------------:|
|              1              |   2   |         18          |        0,001        |          0,059          |

##### Технические метрики
* **Размер хранения в разбивке по типам данных (в Тб)** - для существенных блоков данных:
1. **Объявления** Возьмём число объявлений как суммы созданных объявлений за ближайшие три года, из предположения, что более рание объявления уже были удалены как не актуальные[[1]](#source-1).
Тогда получает 18,6 млн. объявлений = (18 000 000) * 2.64 Мб / 1024 / 1024 = ***6,5*** Тб
2. **Профили** Т.к. есть только приблизительная оценка в 200 млн. пользователей [[1]](#source-1), будем считать что существует 185 млн. человек = 185 000 000 * 0.245 Мб / 1024 / 1024 = ***43.23*** Тб

* **Сетевой трафик**

**Дневная нагрузка**
Получение информации об объявлении = (18 (просмотр объявлений} * 13 710 000 * 2,44 Мб  + 2 {запросы поиска} * 36 {пролистаных карточек объявлений} * 0,39 Мб {картинка + данные короткие об объявлении} * 13 710 000) / 1024 / 1024 = ***574.25*** Тбайт/сутки

**Пиковая нагрузка**
Предположим, что в пиковый час нагрузка составляет 60% от дневной нагрузки, т.е. 8,226 млн. пользователей. Тогда в секунду получится 2 285 человек в секунду.
Получение информации об объявлении = (18 (просмотр объявлений} * 2 285 * 2,44 Мб  + 2 {запросы поиска} * 36 {пролистаных карточек объявлений} * 0,39 Мб {картинка + данные короткие об объявлении} * 2 285) / 1024 * 8 = ***832,89*** Гбит/с

* **RPS в разбивке по типам запросов**

RPS можно посчитать по формуле: {число заходов на строницу одного человек} * 13 710 000 { число пользователь в день } / 24 / 60 / 60

1. **Авторизация или Регистрация**
   1 * 13 710 000 / 24 / 60 / 60 = ***158,68***

2. **Поиск**
   2 * 13 710 000 / 24 / 60 / 60 = ***317,36***

3. **Просмотр объявления**
   18 * 13 710 000 / 24 / 60 / 60 = ***2 856,25***

4. **Создание объявления**
   0,001 * 13 710 000 / 24 / 60 / 60 = ***0,159***

5. **Бронирование объявления**
   0,059 * 13 710 000 / 24 / 60 / 60 = ***9,36***

Суммарный RPS равен 3 341,809
### 3. Логическая схема
![image](https://user-images.githubusercontent.com/48956541/165951415-770d57ce-adc0-482c-aea8-eeab0289904f.png)

### 4. Физическая схема
#### Профили
Информация о пользователях включает в себя текстовые данные и аватар. Т.к. само изображение хранится в отдельном файлов хранилище, будем считать что информация о изображении занимает 50 байт.
```
550 байт * 185 000 000 / 1024 / 1024 / 1024 = 94,79 Гб
```

В связи с широкой географией пользователей, для ускорения и снижения размеров хранимых данных имеет смысл шардировать эту таблицу по географической расположенности.

#### Объявления

Информация об объявлениях включает в себя текстовые данные.

```
6 000 000 * 620 / 1024 / 1024 / 1024 = 3,46 Гб
```

#### Бронирования

Информация о бранировании включает в себя айди пользователя и айди объявления, что можно расчитывать как 8 байт.

```
300 000 000 * 8 / 1024 / 1024 / 1024 = 2,24 Гб
```

#### Картинки

Информация о картинках включает в себя данные о картинках и айди объявления, что может представлять занимать 54 байта.

```
6 000 000 * 9 * 54 / 1024 / 1024 / 1024 = 2,72 Гб
```

#### Сессии

Информация о сессии включает в себя айди сессии, айди пользователя и времени истечения записи, что может представлять занимать 12 байта.

```
13 710 000 * 12 / 1024 / 1024 / 1024 = 0,15 Гб
```


Для хранения данных о картинках, бронировании, объявлений и профиля имеет смысл использовать СУБД PostgreSQL.
Для хранения сессий key-value in-memory хранилище Redis.

Также имеет смысл сделать master-slave репликацию, для большей отказоустойчивости,  
те данные, что не записываются и не требуют моментального чтения можно будет читать во slave сервера

### 5. Технологии

#### Бэкенд

Для этого сервиса подходит ***микросервисная архитектура***. С выделением 3 сервисов: авторизация и регистрация, работы с объявлениями и поиск. 
Данное решение позволит разделить между командами разработки 3 достаточно независимых частей проекта, повысить отказоустойчивость системы и добавить возможность горизонтального масштабирования.
Для взаимодействия сервисом между собой будем использовать протокол grpc, т.к. является быстрым бинарным протоколом, с жёстким API взаимодействия.

Для данного сервиса можно использовать язык ***Go*** на основе следующих причин:
* прост и является в настоящее время достаточно популярным
* имеет множество библиотек упрощающих разработку, в том числе библиотеки для работы с grpc,  
* втроеные в язык горутины и взаимодействие через каналы для распарелеливания задач

#### Фронтенд
Для **фронтенда** можно использовать фреймворк **React.js**. 
Он остается одним из самых популярных фреймворков в последние годы. 
Из плюсов можно выделить высокую производительность, так как он основан на виртуальной модели DOM,
а также высокую переиспользуемость компонентов - всё это дает преимущества в выборе при использовании в проектах типа досок объявлений.

#### База данных

* **Для основных данных** следует использовать **PostgreSQL**. Postgres активно развивается в последние годы. Также подходит для текущей нагрузки.
* **Сессии** будут храниться в key-value хранилище, **Redis**. В качестве ключа будет id пользователя, в качестве id сессии - некоторый UUID с присодинениям к нему id пользователя и взятием от него хэша алгоритмом sha3.

Для хранения изображений используется **Amazon S3**.

#### Балансировка нагрузки
Используем Nginx для балансировки нагрузки и в качестве reverse-proxy.

### 6. Схема проекта
![image](https://user-images.githubusercontent.com/48956541/167146725-66b220cc-f2ab-4a34-9c57-c1e10e2b574e.png)

### 7. Список серверов

Вспомним распределение аудитории по странам:

|      Страны      |  Ежемесячная аудитория, млн. чел.  | Доля от общего числа пользователь |
|:----------------:|:----------------------------------:|:---------------------------------:|
|       США        |                 91                 |               52,6%               |
|  Великобритания  |                15,9                |               9,2%                |
|     Франция      |                15,6                |               9,1%                |
|     Германия     |                8,9                 |               5,1%                |
|        РФ        |                 2                  |               1,2%                |
|    Австралия     |                 7                  |               4,0%                |
|      Канада      |                 9                  |               5,2%                |
|     Бразилия     |                9,7                 |               5,6%                |
|      Италия      |                6,9                 |               3,9%                |
|     Мексика      |                5,5                 |               3,1%                |

Следовательно, можно выбрать 3 дата центра в США, они покроют США, Мексику и Канаду, по одному дата центру в Бразилии и Австралии из-за удалённость этих регионов от остальных. А также два датацентра на Европу, один во франции, второй в Польше [[7]](#source-3).

|      Дата центр               | Число серверов |
|:-----------------------------:|:--------------:|
|       Пикарди, Франция        | 6              |
|  Гродзиск Мазовецкий, Польша  | 6              |
|     Диксон, Австралия         | 6              |
|     Кампинас, Бразилия        | 6              |
|        Сакраменто, США        | 6              |
|    Скрэнтон, США              | 6              |
|      Гейнсвилл, США           | 6              |

В разделе "Физическая схема" было сказанно, что профиль пользователя хранятся разнесённо по териториальному расположению пользователя. В случае перехода пользоваетля в другой регион, а, следовательно, к другому серверу, новый сервер должен будет обратиться к серверу, который хранит информацию об этом профиле, получить её, сохранить в своём хранилище, и для экономии хранилищ вернуть тому серверу подверждение о получении и сохранении профиля, чтобы тот сервер смог удалить из своего хранлища эти данные. 

Также в связи с большой площадью расположения клиентов и большим траффиком, образуемым большим объёмом статики, для уменьшения времени отдачи и распределения нагрузки на сеть на отдачу статических файлов имеет смысл использовать CDN, позволяющий кэшировать эти файлы уже в регионе пользователя, либо ближайщем к нему региону с CDN сервером

Расчитаем две конфигурации серверов: сервера в датацентрах США и Европы и срервера в датацентрах Австралии с Бразилией, в связи с существенной разницой нагрузки на них.

Так с учётом того, что загрузка изображений на клиент происходит обходя сам сервер, следует посчитать пиковый траффик для сервера:
При использовании сайтом 2 285 человек в секунду.
Получение информации об объявлении = (18 (просмотр объявлений} * 2 285 * 620 байт {информация об объявлении без картинки}  + 2 {запросы поиска} * 36 {пролистаных карточек объявлений} * 100 байт {путь к картинке + данные короткие об объявлении} * 2 285 + 2 285 * 550 байт {получение данных о профие без картинке}) / 1024 / 1024 / 1024 * 8 = ***0,21*** Гбит/с

#### Первая конфигурация сервера

Данная конфигурация примет нагрузку не менее 20% от общей. Возьмём с запасом 25%.

Пересчитаем значение метрик под такую нагрузку:
* **Сетевой трафик**
**Пиковая нагрузка** 0,21 * 0,25 = 0,0525 Гбит/с

* **RPS по серверам**

1. **Авторизация или Регистрация**
   158,68 * 0,25 = ***39,67***

2. **Поиск**
   317,36 * 0,25 = ***79,34***

3. **Просмотр объявления, Создание объявления, Бронирование объявления**
   2 865,769 * 0,25 = ***716,442***

Суммарный RPS равен 3 341,809 * 0,25 = 835,45

Также пересчитаем требуемое место для хранение профилей, т.к. предполагалось разнести данные о пользователях по географическому признаку. 94.79 * 0,25 = ***23,69*** Гб

Переходим к расчётам конфигурации машин:

* Nginx

Nginx позволяет поддерживать 4,830 rps HTTPS запросов размером с 100 Кб на одном ядре [[8]](#source-4). С учётом пиковой нагрузки в 0,0525 Гбит/с и числом запросов в 835,45, получаем, что размер одного запроса равен 0,0525 * 1024 * 1024 / 8 / 835,45 = 8 Кб. Следовательно, такая конфигурация Nginx покрывает по сути нагрузку на весь сервис. Для обеспечения такой производительности, возьмём конфигурацию из [[8]](#source-4).

| **Параметр** | **Значение** |
| :-: | :-: |
| CPU (cores) | 1 |
| Network GbE | 40 |
| RAM (Gb) | 16 |
| SSD (Gb) | 32 |

* Авторизация или Регистрация

В связи с относительно небольшой нагрузкой, даже при отказе какого-то из датацентров, данный сервер может обладать простой конфигурацией:

| **Параметр** | **Значение**|
| :-: | :-: |
| CPU (cores) | 2 |
| RAM (Gb) | 8 |
| HDD (Gb) | 20 |

* Поиск

Данный сервис, может в себе содержать сложные поисковые алгоритмы, а также может быть неожиданно нагружен наплывом клиентов. Поэтому сервер должен быть более производителным.

| **Параметр** | **Значение**|
| :-: | :-: |
| CPU (cores) | 3 |
| RAM (Gb) | 16 |
| SSD (Gb) | 40 |

* Объявления

Данный сервис, является самым нагруженным среди сервисов, поэтому должен имееть самую производительную конфигурацию среди сервисов

| **Параметр** | **Значение**|
| :-: | :-: |
| CPU (cores) | 4 |
| RAM (Gb) | 32 |
| SSD (Gb) | 40 |

* Redis

Redis явдяется in-memory хранилищем, следовательно требуется большой объём оперативной памяти.

| **Параметр** | **Значение**|
| :-: | :-: |
| CPU (cores) | 2 |
| RAM (Gb) | 32 |
| HDD (Gb) | 20 |

* PostgreSQL

Сумарный объём данных составляет около 32,11 Гб, возьмём размер памяти с запасом.

| **Параметр** | **Значение**|
| :-: | :-: |
| CPU (cores) | 6 |
| RAM (Gb) | 16 |
| SSD (Gb) | 72 |

#### Вторая конфигурация сервера

Данная конфигурация примет нагрузку не менее 5,6% от общей. Возьмём с запасом 10%.

Пересчитаем значение метрик под такую нагрузку:
* **Сетевой трафик**
**Пиковая нагрузка** 832,89 * 0,1 = 83,289 Гбит/с

* **RPS по серверам**

1. **Авторизация или Регистрация**
   158,68 * 0,1 = ***15,87***

2. **Поиск**
   317,36 * 0,1 = ***31,74***

3. **Просмотр объявления, Создание объявления, Бронирование объявления**
   2 865,769 * 0,1 = ***86,577***

Суммарный RPS равен 0,21 * 0,1 = ***0,021***

Также пересчитаем требуемое место для хранение профилей, т.к. предполагалось разнести данные о пользователях по географическому признаку. 94.79 * 0,1 = ***9,48*** Гб

Переходим к расчётам конфигурации машин:

* Nginx

Можно уменшить размер ОЗУ по сравнению с первой конфигурацией, в связи с ещё меньшим числом запросов.

| **Параметр** | **Значение** |
| :-: | :-: |
| CPU (cores) | 1 |
| Network GbE | 40 |
| RAM (Gb) | 8 |
| SSD (Gb) | 32 |

* Авторизация или Регистрация

| **Параметр** | **Значение**|
| :-: | :-: |
| CPU (cores) | 1 |
| RAM (Gb) | 8 |
| HDD (Gb) | 20 |

* Поиск

| **Параметр** | **Значение**|
| :-: | :-: |
| CPU (cores) | 3 |
| RAM (Gb) | 16 |
| SSD (Gb) | 40 |

* Объявления

| **Параметр** | **Значение**|
| :-: | :-: |
| CPU (cores) | 4 |
| RAM (Gb) | 32 |
| SSD (Gb) | 40 |

* Redis

| **Параметр** | **Значение**|
| :-: | :-: |
| CPU (cores) | 2 |
| RAM (Gb) | 32 |
| HDD (Gb) | 20 |

* PostgreSQL

Сумарный объём данных составляет около 17,9 Гб, возьмём размер памяти с запасом.

| **Параметр** | **Значение**|
| :-: | :-: |
| CPU (cores) | 6 |
| RAM (Gb) | 16 |
| SSD (Gb) | 36 |

### 8. Заключение
В ходе работы было выполнено проектирование высоконагруженной системы - интернет-сервиса для размещения объявлений о сдаче жилья Airbnb.

### 9. Список использованных источников

1. <a id="source-1"></a> https://www.businessofapps.com/data/airbnb-statistics]
2. <a id="source-2"></a> https://www.similarweb.com/ru/search/?q=Airbnb
3. https://news.airbnb.com/about-us/
4. https://ru.wikipedia.org/wiki/Go
5. https://habr.com/ru/post/348542/
6. https://docs.mongodb.com/manual/reference/limits/#data
7. <a id="source-3"></a> https://map.datacente.rs/
8. <a id="source-4"></a> https://www.nginx.com/blog/testing-the-performance-of-nginx-and-nginx-plus-web-servers/
